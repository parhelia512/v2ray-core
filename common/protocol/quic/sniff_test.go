package quic_test

import (
	"encoding/hex"
	"testing"

	"github.com/v2fly/v2ray-core/v4/common"
	"github.com/v2fly/v2ray-core/v4/common/protocol/quic"
)

func TestSniffQUIC(t *testing.T) {
	pkt, err := hex.DecodeString("cd0000000108f1fb7bcc78aa5e7203a8f86400421531fe825b19541876db6c55c38890cd73149d267a084afee6087304095417a3033df6a81bbb71d8512e7a3e16df1e277cae5df3182cb214b8fe982ba3fdffbaa9ffec474547d55945f0fddbeadfb0b5243890b2fa3da45169e2bd34ec04b2e29382f48d612b28432a559757504d158e9e505407a77dd34f4b60b8d3b555ee85aacd6648686802f4de25e7216b19e54c5f78e8a5963380c742d861306db4c16e4f7fc94957aa50b9578a0b61f1e406b2ad5f0cd3cd271c4d99476409797b0c3cb3efec256118912d4b7e4fd79d9cb9016b6e5eaa4f5e57b637b217755daf8968a4092bed0ed5413f5d04904b3a61e4064f9211b2629e5b52a89c7b19f37a713e41e27743ea6dfa736dfa1bb0a4b2bc8c8dc632c6ce963493a20c550e6fdb2475213665e9a85cfc394da9cec0cf41f0c8abed3fc83be5245b2b5aa5e825d29349f721d30774ef5bf965b540f3d8d98febe20956b1fc8fa047e10e7d2f921c9c6622389e02322e80621a1cf5264e245b7276966eb02932584e3f7038bd36aa908766ad3fb98344025dec18670d6db43a1c5daac00937fce7b7c7d61ff4e6efd01a2bdee0ee183108b926393df4f3d74bbcbb015f240e7e346b7d01c41111a401225ce3b095ab4623a5836169bf9599eeca79d1d2e9b2202b5960a09211e978058d6fc0484eff3e91ce4649a5e3ba15b906d334cf66e28d9ff575406e1ae1ac2febafd72870b6f5d58fc5fb949cb1f40feb7c1d9ce5e71b")
	common.Must(err)
	quicHdr, err := quic.SniffQUIC(pkt)
	if err != nil || quicHdr.Domain() != "www.google.com" {
		t.Error("failed")
	}
}

func TestSniffQUICFragment(t *testing.T) {
	pkt, err := hex.DecodeString("cc00000001082e3d5d1b64040c55000044d0ccea69e773f6631c1d18b04ae9ee75fcfc34ef74fa62533c93534338a86f101a05d70e0697fb483063fa85db1c59ccfbda5c35234931d8524d8aac37eaaad649470a67794cd754b23c98695238b8363452333bc8c4858376b4166e001da2006e35cf98a91e11a56419b2786775284942d0f7163982f7c248867d12dd374957481dbc564013ff785e1916195eef671f725908f761099d992d69231336ba81d9e25fe2fa3a6eff4318a6ccf10176fc841a1b315f7b35c5b292266fc869d76ca533e7d14e86d82db2e22eacd350977e47d2e012d8a5891c5aaf2a0f4c2b2dae897c161e5b68cbb4dee952472bdc1e21504b8f02534ec4366ce3f8bf86efc78e0232778fbd554457567112abdcafcf6d4d8fcf35083c25d9495679614aba21696e338c62b585046cc55ba8c09c844361d889a47c3ea703b4e23545a9ab2c0bb369693a9ddfb5daffa85cf80fdd6ad66738664e5b0a551729b4955cff7255afcb04dee88c2f072c9de7400947a1bd9327ac5d012a33000ada021d4c03d249fb017d6ac9200b2f9436beab8183ddfbe2d8aee31ffb7df9e1cc181c1af80c39a89965d18ed12da8e3ebe2ae1fbe4b348f83ba19e3e3d1c9b22bcf03ab6ad9b30fe180623faa291ebad83bcd71d7b57f2f5e2f3b8e81d24fb70b2f2159239e8f21ffafef2747aba47d97ab4081e603c018b10678cf99cab1fb42156a14486fa435153979d7279fd22cd40af7088bfc7eff41af2f4b3c0c8864d0040d74dff427f7bffdb8c278474ea00311326cf4925471a8cf596cb92119f19e0f789490ba9cb77b98015a987d93e0324cf1a38b55109f00c3e6ddc5180fb107bf468323afec9bb49fd6a86418569789d66cafe3b8253c2aebb3af3782c1c54dd560487d031d28e6a6e23e159581bb1d47efc4da3fe1d169f9ffb0ca9ba61af0a38a92fde5bc5e6ec026e8378a6315a7b95abf1d2da790a391306ce74d0baf8e2ce648ca74c487f2c0a76a28a80cdf5bd34316eb607684fe7e6d9e83824a00e07660d0b90e3cddd61ebf10748263474afa88c300549e64ce2e90560bb1a12dee7e9484f729a8a4ee7c5651adb5194b3b3ae38e501567c7dbf36e7bb37a2c20b74655f47f2d9af18e52e9d4c9c9eee8e63745779b8f0b06f3a09d846ba62eb978ad77c85de1ee2fee3fbb4c2d283c73e1ccba56a4658e48a2665d200f7f9342f8e84c2ba490094a4f94feec89e42d2f654f564c2beb2997bafa1fc2c68ad8e160b63587d49abc31b834878d52acfb05fb73d0e059b206162e3c90b40c4bc08407ffcb3c08431895b691a3fea923f1f3b48db75d3e6b91fd319ffe4d486e0e14bd5c6affc838dee63d9e0b80f169b5e6c02c7321dcb20deb2b8e707b60e345a308d505bbf26a93d8f18b39d62632e9a77cbe48b3b32eb8819d6311a49820d40f5acbf0273c91c36b2269a03e72ee64df3dfb10ddefe73c64ef60870b2b77bd99dea655f5fe791b538a929a14d99f6d69685d72431ea5f0f4b27a044f2f575ab474fcc3857895934de1ca2581798eaef2c17fe5aaf2e6add97fa32997c7026f15c1b1ad0e6043ae506027a7c0242546fdc851cca39a204e56879f2cef838be8ec66e0f2292f8c862e06f810eb9b80c7a467ce6e90155206352c7f82b1173ba3b98d35bb72c259a60db20dd1a43fe6d7aef0265e6eaa5caafd9b64b448ff745a2046acbdb65cf2a5007809808a4828dc99097feedc734c236260c584")
	common.Must(err)
	quicHdr, err := quic.SniffQUIC(pkt)
	if err != nil || quicHdr.Domain() != "cloudflare-quic.com" {
		t.Error("failed")
	}
}

func TestSniffQUICFragmentMultiPackets(t *testing.T) {
	pkt, err := hex.DecodeString("c20000000108702c48237ed42f69000044d016e3168577a0918ca498b18ff67e4d06a54e02eca981628a42f21bd81e2088f4a0c0706ce64df7c976b4ac1e4946a8054432ee8844977ef47f4e38e89ae15f49a6bfbb75f0dbc00353985ce3392ba2e377cc26b9ab5414eeb595c833b156ec97fe69f5148406116d3e6bad03d19b76a09f4ec5e1a6ebdf39c6852b7871544688f77a375ad14331ee4fd079e213c1f1cea11a9e67922f9c6d62daa94ea870a6f1013fbf0865ceba62c65964a1798f7a0934117c2a362061eafe9c5917bd8f719d4cb51489e3c2c3b0f9af214f42ded7ca295923a24e2976f49f3507d1e3bafc4163192db23bc6db317167284f0a61e9a564ef42cd6a4c5119f9c0638399ccb424afdb1294b92155f5c58b8d06e6e31587918c07a91842384cae455080c31985f69da7df6c2934fbb6f7a9f2c0d697ef59c8d59bf11052bcb373c52d068f552968b5ab477591bcac335e72b5281ec83808bea06149ce9bde43f0f39709edb34f563118140a8bbca29d5621bd36a12f1d1a4f8fdb4b52570823fe49d4e2920c802cda8b3b9686035163ba4f15de5b36955c5074cac66c10f81b401a17461fa8a8f72f97d6ef326039d07449058bf0f7c12f9c20f5b5b17f583c4a7ece2de8fc2cc70191f26d7f58a271cb4d54fc7b09fb387cc58e73975644568de767867c34eb917939c3ce1a729fe452015982c0e88bf47c092ac9a912579c72eff70dd1c802e3e00f031b593cf42fb7e93a73be618bb5c8cac73d6b189eef514fdede3bc7e5c7ba8e11efa683f9ad81107000bb4094283aca8553f630ec42eaaf52c6d3b51a5aa5cb6276dd1b3c5cf18452329383c84f4026ff6c62b881df87aecb8d6a47b4ced65dcc00c2fe29deca901808e80883f3175533c0350b08feef5bb03c2eab6fcde5c0be054b2e45ff9d0f8a3d4aebdeb68846547a7b1b29f08534dc87748501e42619c409ea364aead9e76b48a6851ee890a610d96b702fb7d114e3bcba3768436329d31fdf792f01e58b52fc9ad21bf9e505226761e60d5a781a8f07ed206d2f616b8028a5f87e982507092ea615260bb68ab6b09896608daacb56ba181cf4dcf562506b267957562a326a1f70af14c3823957ab460a5f32436dfa766ff8f4832a1cc254dc82fae28e73a00694cc34ff9d3696568d0d41c93165d3a5ba065da824dd9f724660f2e9ecba7d4ad5743d99f955c77a5bbea09a8524d63186992679d4a02a000598fdc943c1a9bafa3d31d42a3f027f5f763b94959ba1bc10a9dca69f2da3391ed9e9cf8c86affdde989703a40d934b3acd16ab23acec1f59e325e17d9f075349588aee3f60e70ca5bb73908e43c6650e793aaaace333a1d663e6d59c1211728be7dc1d939c96cfcca62d5b835354a4639cca7217ac9618306488a3b22ccb12b193207cf9ae27273ffd2c0a688418299498ef9e060c32c454c99ee16ff8e4daa60d3b313820a8cc6f2ccc6da63744fb6593d772ded26d274fbfc51853938af86272502374571c574e98605561cf9baf22acac21d45344c64b5e410c381cf6406cae81c1060666aa0f6161af8fd0be3c29b805ce1b0483ac8df84ae9496d08600ad9832cfef6af9a6367e1e55a8b30a48a846ecd1351a3ca2da23298fc0ba1e0c09808bbe09f0e6e667c78358d60b666184ed3840192f5e7e0f413cbc31ec0e1ae9500b6d0538ba44be7f8c5085f240976ab131c777734220ece77b38c075048c8bd481d07e29449f1a27b3d" + "cf0000000108702c48237ed42f69000044d0af10aeb9526af1a7e75764c655022c102c178d966e1f9ba05276c3b9f7e178d698429fe4e465b4ab9697353bf97c9ba3d64fc8697cf987275e7d448f89f3747857a5fff5680f9246d049843c189457e833ee23ff4bfb751b95f46badd3e7b90fcf478bb60916a17b55a8f28c853924a49e144be1714958d3f6d6e8900dcc1861377d6bc99f0f8a23106f2b29902d5ea737b1c402afb80c634bec453d292f442fb3dd9492e3610d6525b25ff4ad22ca338f37267ae63fe67519ab7a6ab159e6311c7e18c4cdc7bf18313481ddfe77e6a002018c40372b0d34c4bd5b80bdd684d3a45cc19b96ed6e76b9f764a0c3d3933833192e37673b19884d39a74e0f68ab58931ce3a0f632a120d2ba0937a40d8dc689d78ac7262bc076c9e2751ea5fa0c5e0805bcf4d8c794e2f78dea806eb341b0516c241dc574669355c4baf472d831b77d8686bbfa8e38506768a1ef78e77dc13c52d82419d07695574e0d6ee9689c5a275f35ee3a7fadb0348cab230ce6072dd0e2c1783b21698fcfd65b06d271649802a6846e568cffd4c1deaf6477ee1b32df00efe561bea55084df9a1dc355532f6987c8b4187ccb086383b557733ef61a535885f7aadd6ada01c106204359469aa2a9688fb6c719367c618821ce16ddad3a1293fe821119b77fa228b36ec7ffb72b08b8e0a7633725ddff946771e0f29cfe651b13d62b859c653bf114ac2af007491458a92d19fb899b6cbea3f8c4b06e6d4d5ea95127aa15e7155746537b6fda838d08072d7af74d1876d932371aaaf67a7822a54e43f98eb04f2ad076a424faa1fcf4d4984a90441e096b5cd8e720d19ee7c0b422b07e8e0b1672adb9f566a5a50984f5d2f640d55765cfde0e5f40dab0e9f07d287949173ce69b4e11e52409c2a63687114c01972fa2d25d450266ba12fa5e31814b63910b903be00ce3a57155147ff8111e8224cf00d74cb6c0e1c41ae2587f471a19d26ee6c1e2a746ba6c2ba4bf261faf44e967645f90a69661e74ac0ce38e00946bfac4869b4abc9ecedd3f631a96f5b3fc1c4175de651f85bb222505a9a09e11df1cde167f658c1c757451f7dff79d6273071a9fd9b8205b37663ed72fdf5c004572c47851c460f006cac8dac2193af0838d0df3447f6c0eea85a0b740d8d6d5f0a01e7dc3959e955f496b969b1460625910ea0de0781fcf1aafc615786ebef925fd226d08c76fb2da1eb41612715f5096df8c893bd0e647c3e80dc025cbae027047a425ce73b9404b971496ce9a1cf0f6cfbf1324af767a3ab150b79367dc98ef03177fff40e96266e7a50ffd8cf03a36de3e3b5c7e1249802a6d967e7718084f0793a08bac7dc44667d4c3c695afdaf2ca6504e6c7c40d7a8a2998681df1af156a61172d16ea699c6955469c81a8caa9e912acf932cde9229667e725076479f6993322e8855597c83222f30eebbe894ce5b9582c161550f97d3dbd7eb5a6114acddc7dddc61c4ce96e424b530ea325c94618815f08dbe1fa13fd793677f74996ff5c8fb930136616904c41aae042c51bb25c764ce11f9a1bbd4ad017ff04c4649ad52cbac766cde3e9705caec28e34e28b759cf5294fb1ee0b94da6ba51c66dc512805ea34c0a72e8128506eb948dd4c5ae76646cb9c275ffcf6794db6d5c82ca2580fe1fc5b4fcec8ffeb375f2b6c6bda2590a8a96e18f07b3f6ea813f7cad33d5befa11818c5956b89541585a70fb53caa021df28d7343f" + "c50000000108702c48237ed42f69000044d04712d4f29ba405f01213ce64f283903fcb38fe41b14269735431bdd187503f3c85c749aade32900e2afd13bee1262fe5ca0f9699683dbeea885c25eee270b0f2e3a2e0a2d0b321d0d003fcb99908ea6da49c828657461a3ac3d1ff5f2bb2a01ba30a1c6d93f23873f658976ee2715ee87bf733789d0dfda0821898223a0f2bf985eca653a1143a137032e880e0f3735feede18110bd7157e494414734c91c3fe11ccd24fc9a2bc6a10c4a8d7d82df8147f4c1021e38008afd723f2893168e3abfdc5406bfe84fb302b16a23bcc323a36be016e8c9072dc0fecfe2ee7e3d902558da858d7e88c2702ab50806aeca03439982a315309b8fb08db9c74de7997620dcccb693a5269e167628b5332c799d7e18d10c36185490650631800bda9c7d94c4a7fc5d5d4411635a348e8fb79943234c35ff91881e46744abbe8d2c3560fb9e1c44bfd15ab79d3af1dc0ebf2adb5cc843e227754cc2d410393a32a82721357cf00798567221c0511ee67da76f29ed16bd842b23fba4baf0d6eab76d94378823cac6a4214ec769cc9d25c41512c10616880e82d06b5ee9923cbcacba3dde2274cce560c4581db86cea0389f553e7e74b23896720ef3f68c5c0fce6614d69f19d0f35ff48db373e5bb65df48f80668910bbed1191108a6a7eb1875fb763805db21a181f982f1e0552328d5a9ee352330a11a2de5d56ff6bdaa2f77861b651f9766422e391efe2f57741e94b4cec1a91caf2f9e76ad7a9942df631cf1dd1bd95dc9b9e99a72350828e705b04a93d6ba32892268bb95d8851d0dfec8cf03360a3bf294cd618878db3ebbed97e6441ddea80885acaf7f1c746324e1e73d09162cb2663278bd4f1e301738441ddf6f843b12f0309d16e8d866fa766d3cabc7843e64aef503d3207cb4b351dc271e73ce52c60df3cd076fb7c1cf1c79ee608dfa3d6cc3919cb5a5da11eb0147c3ebe8a0576509ccda915492e82cdd24b4dafa89858371878f1ac4c422f3b98a9fb03d06e2205014713873553c6f9b8dadcc4d1ca6091d88865dbe41db4f5db1d033fe5984dc9bbd496ae1af19588840cc708ff896229a89b814bddc36eabece1cfa2404db920187fcee01c83f8188fa93eb4cd5ee2ad348a6af4f10c1b7ef3b1793b70f8c76ff8735467f8b3e78feb8fbfd7221a94e40d200e840b019526d6aaa6f37a228e560bbda39fe68bcbe9961626d1356c0731e255c11c71bcfb47c7a6638e1b1a777e0866c25ae7ab0150593c7a278250634fe22b9e9a0bc69cb01e3f65aa1a88543c7c4f802133693db7fb8fba982f4b13e2597a4d008f4d7eddd861c0b28255e1b2ebcc341f78dd001e31469e6cbea3c729c465ebf12742d0bcf9111ebbb45e25f9562629c1c67f0d28f3839b3b5a3ec8bb19ad55ac6da93ef2505c7069e8d9d1cc97035dc78400c7200c88529f9d1e9423e03fc7d59ed55c7aabb10722759768d9c11624d6da7adbffe4d0552ff4f35682bffdb39bf5327d337244d72c25a39e14213c559c843c2355b63a1f4a997f381d44097010e8532908ff6eb82f021b3adad429439c41d79376c1ceb5984de279ed442e033ba12bd6e6f8483369ba36a9e5c2d169391357741a4ee4ffc1f658a4b5e9d40520296a3d2f56abda4dcc0e3d689016e389ae735f8d1164c023f7128f256ef19f2a905d0a2dc45c3a45c5317f5a94035fccdceca1a98bd4a61d7f82c04b8f8efae61bbb86779be3e97033c8ddd0")
	common.Must(err)
	quicHdr, err := quic.SniffQUIC(pkt)
	if err != nil || quicHdr.Domain() != "quic.nginx.org" {
		t.Error("failed")
	}
}
